<!--Para cargar los archivos estáticos-->
{% load static %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - SEVENGAMER</title>
    <link rel="icon" href="{% static 'imagenes/control4.png' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="{% static 'css/pago.css' %}">
</head>

<!-- ENCABEZADO -->
<body>
    <header>
        <div class="container">
            <div class="logo-container">
                <a href="{% url 'sevengamer' %}" style="text-decoration: none;">
                    <p class="logo">SEVENGAMER</p>
                </a>
                <p class="slogan">Juegos de un verdadero gamer</p>
            </div>
        </div>
    </header><!-- Formulario de pago para invitados -->

<div class="payment-form-container">
    <h2>Pago como invitado</h2>
    <form id="form-pago-invitado">
        <!-- Información de pago -->
        <div class="form-group">
            <label for="nombre">Nombre Completo</label>
            <input type="text" id="nombre" name="nombre" required placeholder="Escribe tu nombre">
        </div>
        <div class="form-group">
            <label for="email">Correo Electrónico</label>
            <input type="email" id="email" name="email" required placeholder="Escribe tu correo electrónico">
        </div>
        <div class="form-group">
            <label for="cardType">Tipo de Tarjeta</label>
            <select id="cardType" name="cardType" required>
                <option value="">Selecciona el tipo de tarjeta</option>
                <option value="Visa">Visa</option>
                <option value="MasterCard">MasterCard</option>
                <option value="Amex">American Express</option>
            </select>
        </div>
        <div class="form-group">
            <label for="cardName">Nombre en la Tarjeta</label>
            <input type="text" id="cardName" name="cardName" required placeholder="Nombre del titular">
        </div>
        <div class="form-group">
            <label for="cardNumber">Número de Tarjeta</label>
            <input type="text" id="cardNumber" name="cardNumber" required placeholder="Número de tarjeta" maxlength="16">
        </div>
        <div class="form-group">
            <label for="expiryDate">Fecha de Expiración</label>
            <input type="month" id="expiryDate" name="expiryDate" required>
        </div>
        <div class="form-group">
            <label for="cvv">Código de Seguridad (CVV)</label>
            <input type="text" id="cvv" name="cvv" required placeholder="Código de seguridad">
        </div>

        <!-- Botón para enviar el formulario -->
        <button type="submit" class="submit-btn">Proceder al Pago</button>
    </form>
</div>

 <script>
    // Comprobar si el usuario está autenticado
    const esUsuarioAutenticado = {{ user.is_authenticated|yesno:"true,false" }};

    // Obtener el formulario de pago
    const form = document.getElementById('payment-form');

    // Evento de envío del formulario
    form.addEventListener('submit', function(event) {
      event.preventDefault();  // Prevenir el envío del formulario tradicional

      // Datos del formulario
      const cardType = document.getElementById('cardType').value;
      const cardName = document.getElementById('cardName').value;
      const cardNumber = document.getElementById('cardNumber').value;
      const expiryDate = document.getElementById('expiryDate').value;
      const cvv = document.getElementById('cvv').value;

      // Crear un objeto con los datos del formulario
      const paymentData = {
        cardType,
        cardName,
        cardNumber,
        expiryDate,
        cvv
      };

      // Comprobar si el usuario está autenticado y enviar el pago
      if (esUsuarioAutenticado === 'true') {
        // Enviar al backend como usuario autenticado
        fetch('/procesar_pago/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // Incluir CSRF token para seguridad
          },
          body: JSON.stringify(paymentData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = data.redirect_url;  // Redirigir después de un pago exitoso
          } else {
            alert('Error en el pago: ' + data.error);
          }
        })
        .catch(error => alert('Error en el procesamiento del pago: ' + error));
      } else {
        // Enviar al backend como invitado
        fetch('/procesar_pago_invitado/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // Incluir CSRF token para seguridad
          },
          body: JSON.stringify(paymentData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = data.redirect_url;  // Redirigir después de un pago exitoso
          } else {
            alert('Error en el pago: ' + data.error);
          }
        })
        .catch(error => alert('Error en el procesamiento del pago: ' + error));
      }
    });
  </script>
  

{% endblock %}